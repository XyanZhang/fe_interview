# Fiber 架构

## react 15以及之前的问题

之前版本react 在渲染组件的时候，从开始到渲染完成整个过程无法中断，如果组件较大，js线程会一直执行，等整棵树 VDOM 计算完成后，才会交给渲染的线程这就会导致一些用户交互、动画等任务无法立即得到处理，导致卡顿

## 16 以后

+ 为每个任务增加了优先级，优先级高的可以中断低优先级的任务。然后再重新执行，注意是重新执行优先级低的任务
+ 增加了异步任务，调用requestIdleCallback api, 浏览器空闲的时候执行
+ dom diff 树变成了链表，一个dom对应两个Fiber（一个链表），对应两个队列，这都是为找到被中断的任务 ，重新执行

## 解决

Fiber 把渲染更新过程拆分为多个子任务，每次只做一小部分，做完看是否还有剩余时间，如果有继续下一个任务，如果没有，挂起当前任务，将时间控制交给主线程，等主线程不忙的时候再继续执行即可以中断与恢复，恢复也可以复用之前的中间状态，并给不同的任务赋予不同的优先级，其中每个任务更新单元为 React Element 对应的Fiber节点

实现的上述方式的是 requestIdleCallback 方法

在浏览器空闲时段内调用的函数排队，让浏览器有时间再进行页面的渲染。

基于Fiber节点实现，每个Fiber对应一个React element，保存了该组件的类型（函数组件/类组件/原生组件等等）、对应的dom节点信息。

每个Fiber保存了本次更新中该组件改变的状态、要执行的工作。

多个Fiber节点根据如果三个属性构建一棵树

```jsx
// 指向父级Fiber节点
this.return = null;
// 指向子Fiber节点
this.child = null;
// 指向右边第一个兄弟Fiber节点
this.sibling = null;
```