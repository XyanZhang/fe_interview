# 大文件上传

## 分片上传

1. 将需要上传的文件按照一定的分割规则，分割成相同大小的数据块
2. 初始化一个分片上传任务，返回本地分片上传唯一标识
3. 按照一定的策略（并行或串行）发送各个数据块，
4. 发送完成后，服务端根据判断数据上传是否完成，如果完整，则进行数据块合并得到原始文件

### 分片上传完成状态判断

后端返回合并成功的信息给前端的时机可以有多种选择，取决于具体的实现方式和需求。以下是两种常见的时机：

+ 前端传完最后一个文件片段：在前端将最后一个文件片段上传到后端后，后端可以进行判断，如果所有文件片段都已经接收完毕，则进行文件合并、校验等操作，并在完成这些操作后，返回合并成功的信息给前端。
+ 后端检测到已经传完并合并完文件：后端可以在接收到每个文件片段时，记录已接收的片段数量，并与需要接收的总片段数量进行对比。当已接收的片段数量等于总片段数量时，后端可以判断所有片段已经传完，并进行文件合并、校验等操作。然后，返回合并成功的信息给前端。

## 断点续传

实现方式

1. 服务端返回，告知从哪儿开始
2. 浏览器端自行处理

上传过程中将文件在服务器写为临时文件，等全部写完了（文件上传完），将次临时文件重命名为正式文件即可

如果中途上传中断过，下次上传的时候根据临时文件大小，作为在客户端读取文件的偏移量，从此位置继续读取文件数据块，上传到服务器从此偏移量继续写入文件即可

## 进度显示

实时显示上传进度。前端可以通过XMLHttpRequest的progress事件获取上传进度信息，并将其展示给用户。可以使用进度条、百分比等形式展示上传进度。

## 实现思路

1. 前端将文件切割成多个片段，并为每个片段生成唯一的标识符（例如索引号、哈希值等）。
2. 创建一个FormData对象，用于存储需要上传的文件片段及相关信息。
3. 使用AJAX、Fetch或WebSocket等技术，将FormData对象发送给后端。可以使用POST请求进行传输。
4. 后端接收到请求后，解析表单数据，获取每个片段的数据及相关信息。
5. 后端根据片段的标识符，将每个片段保存到临时文件或内存中。
6. 当所有片段都上传完成后，后端根据标识符将这些片段合并成完整的文件。
7. 合并完成后，可以进行必要的校验操作，例如校验文件的哈希值或其他完整性检查。
8. 最后，返回合并后的文件的相关信息给前端，表示上传成功。
